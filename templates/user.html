{% include 'header.html' %}
<body>
    {% set sessName = getSess( ) %}
    {% if sessName %}
    <section class="page-header">
        <div class="ui fluid container">
            <div class="ui grey secondary menu">
                <a class="item active">{{ getInfo( sessName, 'full_name') }}</a>
                <div class="right menu">
                    <a href="{{ url_for( 'logout' ) }}" class="ui item">Logout</a>
                </div>
            </div>
        </div>
    </section>
    {% endif %}

    <section class="hero">
        <div class="ui fluid container">
            <div class="ui grid profile">
                <div class="four wide column">
                    <img class="profile-picture" src="../profile_picture/{{ username }}" />
                </div>
                <div class="four wide column">
                    {% if uInfo %}
                    <h1>{{ uInfo.full_name }}</h1>
                    <h2>{{ uInfo.program }}</h2>
                    <p>{{ uInfo.birthday }}</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </section>

    <section class="search-bar">
        <div class="ui search large">
            <div class="ui icon input">
                <input class="prompt search-field" type="text" placeholder="Search">
                <i class="search icon"></i>
            </div>
        </div>
    </section>

    <section class="mates">
        <div class="ui fluid container">
            {% if mInfo %}
                <h1>Mates</h1>
                <div class="ui doubling grid">
                    {% for mate in mInfo %}
                    {% set rowInfo = dictFromRow( mate ) %}
                    <div class="column mate">
                        <div class="image">
                            <a class="ui" href="{{ rowInfo.mateID }}" data-tooltip="{{ getInfo( rowInfo.mateID, 'full_name' ) }}">
                                <img class="mate-picture" src="../profile_picture/{{ rowInfo.mateID }}" />
                            </a>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% endif %}
        </div>
    </section>

    <section class="content">
        <div class="ui text container {% if sessName != username %}hidden--force{% endif %}">
            <div class="ui cards">
                <div class="ui raised fluid card create-post">
                    <div class="content">
                        <h1 class="post-header">Make Post</h1>
                        <div class="description">
                            <div class="actions">
                                <textarea class="post-area" placeholder="What do your mates want to hear?"></textarea>
                            </div>
                        </div>
                    </div>
                    <div class="extra-content">
                        <div class="actions">
                            <button class="ui button action-create" data-type="Post" data-parent="{{ username }}">Create</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="ui text container">
            <div class="ui cards">
                {% for post in pInfo %}
                {% set rowInfo = dictFromRow( post ) %}
                <div class="ui raised fluid card post" id="post-{{ rowInfo.pID }}">
                    <div class="content">
                        <div class="right floated author">
                            <img class="ui avatar image" src="../profile_picture/{{ rowInfo.zID }}"> {{ username }}
                        </div>
                        <div class="description">
                            <p>{{ rowInfo.message|doMention|safe|urlize(40) }}</p>
                            <span class="right floated time">{{ rowInfo.time|truncate( 10, True, '' ) }}</span>
                            <div class="actions">
                                <a class="reply" data-type="Comment" data-parent="{{ rowInfo.pID }}">Reply</a>
                            </div>
                        </div>
                    </div>
                    <div class="extra content">
                        <div class="ui comments">
                            {% set comments = getPost( rowInfo.pID, 'Comment' ) %}
                            {% if comments|length > 0 %}
                            <h3 class="ui dividing header">Comments</h3>
                            {% else %}
                            {% endif %}
                            {% set counter = [ ] %}
                            {% for comment in comments %}
                            {% set row_Info = dictFromRow( comment ) %}
                            {% if counter.append('1') %}{% endif %}
                            <div class="comment" id="comment-{{ rowInfo.cID }}">
                                <a class="avatar">
                                    <!-- <img src="../profile_picture/{{ row_Info.zID}}"> -->
                                </a>
                                <div class="content">
                                    <a href="{{ row_Info.zID }}" class="author">{{ getInfo( row_Info.zID, "full_name" )}}</a>
                                    <div class="metadata">
                                        <span class="date">{{ row_Info.time|truncate( 10, True, '' ) }}</span>
                                    </div>
                                    <div class="text">{{ row_Info.message|doMention|safe }}</div>
                                    <div class="actions">
                                        <a class="reply" data-type="Reply" data-parent="{{ rowInfo.pID }}">Reply</a>
                                    </div>
                                </div>
                                {% set replies = getPost( row_Info.cID, 'Reply' ) %}
                                {% for reply in replies %}
                                {% set rowInfo_ = dictFromRow( reply ) %}
                                <div class="comments minimal replies" id="reply-{{ rowInfo.rID }}">
                                    <div class="comment">
                                        <a class="avatar">
                                            <!-- <img src="../profile_picture/{{ rowInfo_.zID}}"> -->
                                        </a>
                                        <div class="content">
                                            <a href="{{ rowInfo_.zID }}" class="author">{{ getInfo( rowInfo_.zID, "full_name" )}}</a>
                                            <div class="metadata">
                                                <span class="date">{{ rowInfo_.time|truncate( 10, True, '' ) }}</span>
                                            </div>
                                            <div class="text">{{ rowInfo_.message|doMention|safe }}</div>
                                            <!-- <div class="actions">
                                                <a class="reply">Reply</a>
                                            </div> -->
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            {% endfor %}
                            {% if counter|length > 5 %}
                            <button data-toggle="{{ rowInfo.pID }}" class="mini ui grey button toggle_comments">Show more comments.</button>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </section>
    </div>

    <div class="ui modal search-results">
    </div>
</div>

    {% if username == getSess( ) %}
        {% if uInfo.courses %}
            <p>Courses: {{ uInfo.courses }}</p>
        {% endif %}
        {% if uInfo.password %}
            <p>Password: {{ uInfo.password }}</p>
        {% endif %}
    {% endif %}
    <textarea>{{ uInfo|string }}</textarea>
    <textarea>{{ pInfo|string }}</textarea>

    <script>

    $( '.ui.modal' ).modal( );

    $( '.search-field').keypress( function( e ) {
        console.log( 'Text:' + $( '.search-field' ).val( ) );
        if( event.which == 13 ) {
            if( $( '.search-field' ).val( ).length > 2 ) {
                $.post(
                    '{{ url_for( "search" ) }}', { search: $( '.search-field' ).val( ) },
                function( data ) {
                    $( '.search-results' ).html( data );
                    $( '.menu .item' ).tab( {
                        'onVisible': function( ) {
                            $( '.ui.modal' ).modal( 'refresh' );
                        } } );
                    $( '.ui.modal' ).modal( 'show' );
                } );
            }
        }
    } );

    $( '.toggle_comments' ).on( 'click', function( ) {
        var pID = $( this ).data( "toggle" )
        var text = $( this ).text( );
        console.log( text );
        if( text == "Show more comments." ) {
            $( this ).text( "Hide comments." );
        } else {
            $( this ).text( "Show more comments." );
            $('html, body').animate({        // Scroll to Result
                scrollTop: $( "#post-" + pID ).offset().top
            }, 500 );
        }
        $( "#post-" + pID + " div:nth-child(n+6)").toggle( "500" );
    });

    $( '.action-create' ).on( 'click', function( ) {
        console.log( "Parent: " + $( '.action-create' ).data( "parent" ) );
        console.log( "Type: " + $( '.action-create' ).data( "type" ) );

        if( $( '.post-area' ).val( ).length < 5 ) {
            console.log( "Message is too short!" );
        } else {
            $.post(
                '{{ url_for( "create" ) }}', {
                    zID: '{{ sessName }}',
                    message: $( '.post-area' ).val( ),
                    parent: $( '.action-create' ).data( "parent" ),
                    type: $( '.action-create' ).data( "type" ) },
            function( data ) {
                // console.log( "Reponse: " + data );
                // console.log( "Message Sent?" );
                location.reload( );
            } );
        }
    } );

    $( '.reply' ).on( 'click', function( ) {
        var me = $( this );
        $( '.create-post' ).insertAfter( this ).hide( ).show( 'slow' );
        $( '.action-create' ).data( "type", me.data( "type" ) ).data( "parent", me.data( "parent" ) );
        $( '.post-header' ).text( "Reply to " + me.data( "type" ) );
    } );
    </script>

</body>
</html>
